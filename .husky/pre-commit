#!/bin/sh

# Get list of staged files for conditional checks
STAGED_FILES=$(git diff --cached --name-only)

# Run lint-staged (formats and lints staged files)
pnpm lint-staged

# TypeCheck source code (always - matches CI)
echo "üîç Type checking source code..."
pnpm typecheck

# TypeCheck test files (always - matches CI)
echo "üîç Type checking test files..."
pnpm typecheck:tests

# Run tests with coverage (always - matches CI)
echo "üß™ Running tests with coverage..."
pnpm test:coverage

# Detect what changed
HAS_SRC_CHANGES=$(echo "$STAGED_FILES" | grep -E 'packages/.*/src/.*\.(ts|tsx)' || true)
HAS_DOC_CHANGES=$(echo "$STAGED_FILES" | grep -E '(docs/|typedoc\.json)' || true)

# Build docs only if API or docs changed (using fast mode)
if [ -n "$HAS_SRC_CHANGES" ] || [ -n "$HAS_DOC_CHANGES" ]; then
  echo "üìö Building documentation (fast mode)..."
  pnpm docs:build:fast || {
    echo ""
    echo "‚ùå Documentation build failed."
    echo "üí° Run: pnpm docs:build"
    echo ""
    exit 1
  }
  
  # Restore docs folder (we just wanted to check it builds)
  git checkout docs/api/generated/
else
  echo "‚è≠Ô∏è  Skipping docs build (no API or doc changes)"
fi

# Always format and normalize all markdown files
echo "üé® Formatting markdown files..."
pnpm prettier --write '**/*.md' --log-level=error > /dev/null 2>&1
node scripts/normalize-punctuation.js > /dev/null 2>&1
git add '**/*.md'

# Check for changeset (only on feature branches)
BRANCH=$(git branch --show-current)
case "$BRANCH" in
  sprint-*|feat/*|fix/*)
    if [ -z "$(ls .changeset/*.md 2>/dev/null | grep -v README)" ]; then
      echo ""
      echo "‚ö†Ô∏è  No changeset found. Consider: pnpm changeset"
      echo ""
    fi
    ;;
esac