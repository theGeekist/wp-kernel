#!/bin/sh

# Get list of staged files for conditional checks
STAGED_FILES=$(git diff --cached --name-only)

# Run lint-staged (formats and lints staged files)
pnpm lint-staged


# Smarter typecheck logic based on staged changes
echo "ðŸ” Checking which packages changed for typecheck..."
HAS_CORE_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/core/' || true)
HAS_UI_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/ui/' || true)
HAS_CLI_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/cli/' || true)
HAS_PHP_DRIVER_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/php-driver/' || true)
HAS_PHP_AST_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/php-json-ast/' || true)
HAS_WP_JSON_AST_CHANGES=$(echo "$STAGED_FILES" | grep -E '^packages/wp-json-ast/' || true)
HAS_SHOWCASE_CHANGES=$(echo "$STAGED_FILES" | grep -E '^examples/showcase/' || true)
pnpm format
git add --all
TYPECHECKS_EXECUTED=0
CLI_TYPECHECK_RAN=0
UI_TYPECHECK_RAN=0
PHP_DRIVER_TYPECHECK_RAN=0
PHP_AST_TYPECHECK_RAN=0
WP_JSON_AST_TYPECHECK_RAN=0
SHOWCASE_TYPECHECK_RAN=0

run_cli_typechecks() {
  if [ "$CLI_TYPECHECK_RAN" -eq 0 ]; then
    CLI_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” CLI changes detected: running typecheck and typecheck:tests for CLI..."
    pnpm --filter @wpkernel/cli typecheck
    pnpm --filter @wpkernel/cli typecheck:tests
  fi
}

run_ui_typechecks() {
  if [ "$UI_TYPECHECK_RAN" -eq 0 ]; then
    UI_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” UI changes detected: running typecheck and typecheck:tests for UI..."
    pnpm --filter @wpkernel/ui typecheck
    pnpm --filter @wpkernel/ui typecheck:tests
  fi
}

run_php_driver_typechecks() {
  if [ "$PHP_DRIVER_TYPECHECK_RAN" -eq 0 ]; then
    PHP_DRIVER_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” PHP driver changes detected: running typecheck and typecheck:tests for php-driver..."
    pnpm --filter @wpkernel/php-driver typecheck
    pnpm --filter @wpkernel/php-driver typecheck:tests
  fi
}

run_php_ast_typechecks() {
  if [ "$PHP_AST_TYPECHECK_RAN" -eq 0 ]; then
    PHP_AST_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” PHP JSON AST changes detected: running typecheck and typecheck:tests for php-json-ast..."
    pnpm --filter @wpkernel/php-json-ast typecheck
    pnpm --filter @wpkernel/php-json-ast typecheck:tests
  fi
}

run_wp_json_ast_typechecks() {
  if [ "$WP_JSON_AST_TYPECHECK_RAN" -eq 0 ]; then
    WP_JSON_AST_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” WP JSON AST changes detected: running typecheck and typecheck:tests for wp-json-ast..."
    pnpm --filter @wpkernel/wp-json-ast typecheck
    pnpm --filter @wpkernel/wp-json-ast typecheck:tests
  fi
}

run_showcase_typechecks() {
  if [ "$SHOWCASE_TYPECHECK_RAN" -eq 0 ]; then
    SHOWCASE_TYPECHECK_RAN=1
    TYPECHECKS_EXECUTED=1
    echo "ðŸ” Showcase changes detected: running typecheck and typecheck:tests for Showcase..."
    pnpm --filter wp-kernel-showcase typecheck
    pnpm --filter wp-kernel-showcase typecheck:tests
  fi
}

if [ -n "$HAS_CORE_CHANGES" ]; then
  echo "ðŸ” Core changes detected: running typecheck and typecheck:tests for all packages..."
  pnpm typecheck
  pnpm typecheck:tests
else
  if [ -n "$HAS_UI_CHANGES" ]; then
    run_ui_typechecks
    run_cli_typechecks
  fi

  if [ -n "$HAS_CLI_CHANGES" ]; then
    run_cli_typechecks
  fi

  if [ -n "$HAS_PHP_DRIVER_CHANGES" ]; then
    run_php_driver_typechecks
  fi

  if [ -n "$HAS_PHP_AST_CHANGES" ]; then
    run_php_ast_typechecks
  fi

  if [ -n "$HAS_WP_JSON_AST_CHANGES" ]; then
    run_wp_json_ast_typechecks
  fi

  if [ -n "$HAS_SHOWCASE_CHANGES" ]; then
    run_showcase_typechecks
  fi

  if [ "$TYPECHECKS_EXECUTED" -eq 0 ]; then
    echo "â­ï¸  No package changes detected: skipping typecheck and typecheck:tests."
  fi
fi

# Run tests with coverage (always - matches CI)
echo "ðŸ§ª Running tests with coverage..."
pnpm test:coverage

# Detect what changed
HAS_SRC_CHANGES=$(echo "$STAGED_FILES" | grep -E 'packages/.*/src/.*\.(ts|tsx)' || true)
HAS_DOC_CHANGES=$(echo "$STAGED_FILES" | grep -E '(docs/|typedoc\.json)' || true)

# Build docs only if API or docs changed (using fast mode)
# if [ -n "$HAS_SRC_CHANGES" ] || [ -n "$HAS_DOC_CHANGES" ]; then
#   echo "ðŸ“š Building documentation (fast mode)..."
#   pnpm docs:build:fast || {
#     echo ""
#     echo "âŒ Documentation build failed."
#     echo "ðŸ’¡ Run: pnpm docs:build"
#     echo ""
#     exit 1
#   }
  
#   # Restore docs folder (we just wanted to check it builds)
#   git checkout docs/api/generated/
# else
  echo "â­ï¸  Skipping docs build (no API or doc changes)"
# fi

# Always format and normalize all markdown files
# echo "ðŸŽ¨ Formatting markdown files..."
# pnpm prettier --write '**/*.md' --log-level=error > /dev/null 2>&1
# node scripts/normalize-punctuation.js > /dev/null 2>&1
# git add '**/*.md'

# Note: Manual versioning - update CHANGELOG.md files in affected packages before committing
