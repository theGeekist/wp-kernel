#!/bin/sh

# Run lint-staged (formats and lints staged files)
pnpm lint-staged

# TypeScript type check for test files
echo "ğŸ” Type checking test files..."
pnpm typecheck:tests || {
  echo ""
  echo "âŒ TypeScript errors in test files. Please fix before committing."
  echo "ğŸ’¡ Run: pnpm typecheck:tests"
  echo ""
  exit 1
}

# Enforce test coverage before allowing commit
echo "ğŸ§ª Running tests with coverage threshold..."
pnpm test:coverage

# Build documentation to catch syntax errors
echo "ğŸ“š Building documentation..."
pnpm docs:build || {
  echo ""
  echo "âŒ Documentation build failed. Please fix syntax errors."
  echo "ğŸ’¡ Run: pnpm docs:build"
  echo ""
  exit 1
}

# Format generated docs to ensure consistency
echo "ğŸ¨ Formatting generated documentation..."
pnpm format docs/api/generated/

# Check for changeset (only on feature branches)
BRANCH=$(git branch --show-current)
case "$BRANCH" in
  sprint-*|feat/*|fix/*)
    if [ -z "$(ls .changeset/*.md 2>/dev/null | grep -v README)" ]; then
      echo ""
      echo "âš ï¸  No changeset found. Creating one is recommended for tracking changes."
      echo "ğŸ’¡ Run: pnpm changeset"
      echo ""
      # Don't fail - just warn
      # exit 1
    fi
    ;;
esac
