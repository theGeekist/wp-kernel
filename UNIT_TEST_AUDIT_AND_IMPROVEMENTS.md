# Monorepo Unit Test Audit & Consolidated Plan

## Cross-Package Themes

- Environment bootstrapping is duplicated across suites, especially when stubbing WordPress globals or browser APIs in `@wpkernel/core` and `@wpkernel/ui`, increasing drift risk whenever platform contracts change even though we already ship canonical globals in `tests/test-globals.d.ts`, shared lifecycle helpers in `tests/test-utils/wp.ts`, and reference patterns in `tests/TEST_PATTERNS.md`.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L26-L52】【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L27-L122】【F:tests/test-globals.d.ts†L1-L62】【F:tests/test-utils/wp.ts†L1-L105】
- Tests often rely on manual cleanup of globals or temporary directories, which can leak state if assertions fail; this affects action runtime overrides, UI symbol markers, and e2e workspace utilities despite the shared reset flows documented in `tests/TEST_PATTERNS.md`.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L165-L188】【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L124-L155】【F:packages/e2e-utils/src/**tests**/integration-workspace.test.ts†L5-L72】【F:tests/TEST_PATTERNS.md†L123-L166】
- Coverage skews toward happy-path flows, with limited scenario matrices for failure handling (CLI command errors, cache resolver fallbacks, workspace failures), leaving critical diagnostics under-tested while helper modules go uncovered, reducing the incentive to adopt them.【F:packages/cli/src/**tests**/version.test.ts†L1-L8】【F:packages/core/src/**tests**/integration/cache-invalidation.test.ts†L29-L136】【F:packages/e2e-utils/src/**tests**/integration-cli-runner.test.ts†L3-L71】【F:tests/TEST_PATTERNS.md†L201-L226】

### Shared Helper Inventory

- **Global Contracts** – `tests/test-globals.d.ts` extends `Window`, `globalThis`, and Jest matchers so suites can interact with WordPress globals without redeclaring ambient types.【F:tests/test-globals.d.ts†L1-L66】
- **WordPress Harness** – `tests/test-utils/wp.test-support.ts` provides the canonical helpers (re-exported via the long-lived `tests/test-utils/wp.ts` barrel for backwards compatibility). New WordPress-specific utilities should extend this module, follow the `*.test-support.ts` naming convention, and register any additional exports through the barrel so suites have a single import surface.【F:tests/test-utils/wp.ts†L1-L1】【F:tests/test-utils/wp.test-support.ts†L1-L115】
- **Testing Playbook** – `tests/TEST_PATTERNS.md` documents supported globals, required teardown, and examples for adopting shared utilities; all package-level improvements must reference or extend these conventions rather than duplicating them.【F:tests/TEST_PATTERNS.md†L1-L226】

## Actionable Next Steps

1. Stand up shared harness modules (e.g., `packages/core/tests/wp-environment.test-support.ts`, `packages/ui/tests/ui-harness.test-support.ts`, `packages/e2e-utils/src/test-support/isolated-workspace.test-support.ts`) that build on the repo-level helpers above. New helpers must use the `*.test-support.ts` suffix, expose a barrel (if multiple helpers exist) to mirror the repo-level pattern, and register their availability in the corresponding `AGENTS.md` so other teams can reuse them without spelunking.【F:packages/core/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L10-L15】【F:packages/ui/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L10-L15】【F:packages/e2e-utils/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L10-L15】
2. Introduce scenario tables and negative-path fixtures across packages to exercise retries, policy failures, CLI error codes, and workspace faults, reducing reliance on single-path integration tests. Shared helpers should include typed fixture builders and cleanup automation so suites adopting them start with high-quality patterns.【F:packages/core/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L16-L19】【F:packages/cli/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L9-L15】【F:packages/e2e-utils/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L12-L16】
3. Add golden-file and snapshot-based assertions for generated assets (CLI templates, manifest diffs) while using fixture builders to describe expected structures declaratively, improving readability and regression coverage. Helpers that emit files must ship self-tests so they do not depress coverage targets for their parent package.【F:packages/cli/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L12-L15】【F:packages/e2e-utils/UNIT_TEST_AUDIT_AND_IMPROVEMENTS.md†L13-L15】

### Naming & Coverage Standards

- Helper modules should always adopt the `.test-support.ts` suffix (for CommonJS compatibility, `.test-support.js` barrels may re-export TypeScript outputs) to align with the shared playbook and reduce cognitive load across packages.【F:tests/test-utils/wp.ts†L1-L1】【F:tests/TEST_PATTERNS.md†L17-L122】
- Any new shared helper must include accompanying unit tests that live beside the helper (e.g., `tests/__tests__/wp.test.ts`) so the helper code contributes positively to coverage rather than diluting package thresholds.【F:tests/test-utils/**tests**/wp.test.ts†L1-L120】
