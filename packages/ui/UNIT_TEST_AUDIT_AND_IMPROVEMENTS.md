# Unit Test Audit & Improvement Plan

## Key Observations

- Hook suites such as `useAction` reimplement runtime factories, React wrappers, and WordPress data stubs inline, leading to lengthy boilerplate and inconsistent defaults between files despite the global harness patterns already captured in `tests/test-utils/wp.test-support.ts`, the compatibility barrel `tests/test-utils/wp.ts`, and `tests/TEST_PATTERNS.md`.【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L27-L122】【F:tests/test-utils/wp.test-support.ts†L1-L115】【F:tests/test-utils/wp.ts†L1-L1】【F:tests/TEST_PATTERNS.md†L17-L78】
- Tests mute console errors and manually clear symbol markers to keep shared globals stable, signalling missing lifecycle utilities for resetting Kernel UI state even though `tests/TEST_PATTERNS.md` calls out shared teardown helpers that UI has not yet adopted.【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L124-L155】【F:tests/TEST_PATTERNS.md†L123-L166】
- Visibility/prefetch hooks construct custom DOM harnesses and override browser APIs (`IntersectionObserver`, `requestAnimationFrame`) per spec, duplicating scaffolding that could live in a shared helper.【F:packages/ui/src/hooks/**tests**/useVisiblePrefetch.test.tsx†L17-L198】
- Many hook tests focus on happy-path resource mocks without table-driven scenarios for error propagation, pending states, or multi-resource orchestration, making it harder to extend behaviour safely.

## Actionable Improvements

1. Build a `createKernelUITestHarness()` inside `tests/ui-harness.test-support.ts` that wraps the repo-level WordPress helpers, returns provider wrappers, mock reporters, and data registration shims, and document its usage in both `packages/ui/AGENTS.md` and `tests/TEST_PATTERNS.md` to steer teams toward consistent patterns.【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L27-L122】【F:tests/TEST_PATTERNS.md†L78-L122】
2. Export reset utilities (e.g., `resetActionStoreRegistration`, `restoreConsole`) from the harness so global clean-up happens in shared `beforeEach`/`afterEach`, removing the need for per-file console monkeypatching. The helper must ship a focused self-test to keep coverage neutral.【F:packages/ui/src/hooks/**tests**/useAction.test.tsx†L124-L155】
3. Factor out a DOM interaction helper (e.g., `withIntersectionObserverMock`) in `tests/dom-observer.test-support.ts` that provisions observers, raf stubs, and cleanup hooks, so visibility-related specs share consistent behaviour and reduce manual event wiring.【F:packages/ui/src/hooks/**tests**/useVisiblePrefetch.test.tsx†L17-L198】
4. Introduce `describe.each` tables for hook states (idle/loading/error/success) and extend resource fixtures with failure modes so we cover asynchronous edge cases without expanding single-case tests into sprawling blocks.
5. Surface the shared helper catalogue (`tests/test-utils/wp.test-support.ts`, UI-specific harness files) in `README.md`, `AGENTS.md`, and suite-level docs, reinforcing the `.test-support.ts` naming convention and ensuring contributors add companion unit tests for new helpers to protect package coverage.【F:tests/TEST_PATTERNS.md†L1-L122】【F:tests/test-utils/**tests**/wp.test.ts†L1-L120】【F:packages/ui/tests/ui-harness.test-support.ts†L1-L160】
