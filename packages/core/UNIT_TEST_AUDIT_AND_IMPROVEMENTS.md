# Unit Test Audit & Improvement Plan

## Key Observations

- Integration suites repeatedly stub `window.wp` objects, duplicating `apiFetch`, `hooks.doAction`, and data store mocks across files even though `tests/test-globals.d.ts`, `tests/test-utils/wp.test-support.ts`, and the legacy barrel `tests/test-utils/wp.ts` already expose canonical globals. The drift grows whenever WordPress APIs change.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L26-L52】【F:packages/core/src/**tests**/integration/resource-flow.test.ts†L23-L71】【F:tests/test-utils/wp.test-support.ts†L1-L115】【F:tests/test-utils/wp.ts†L1-L1】【F:tests/test-globals.d.ts†L1-L66】
- Several tests mutate globals (e.g., `__WP_KERNEL_ACTION_RUNTIME__`) to inject policies or background job state, creating hidden coupling between cases and requiring manual cleanup that `tests/TEST_PATTERNS.md` warns about but does not yet automate for core packages.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L165-L188】【F:tests/TEST_PATTERNS.md†L123-L166】
- Cache invalidation coverage exercises real `@wordpress/data` stores and includes conditional skips to accommodate missing resolver hooks, signalling an unreliable fixture surface and slow execution path.【F:packages/core/src/**tests**/integration/cache-invalidation.test.ts†L29-L136】
- Build verification suites focus on high-level flows but lack targeted assertions for edge cases like concurrent invalidations or transport retry semantics, making regressions hard to localise (no dedicated unit focus beyond integration harness).

## Actionable Improvements

- [x] **Shared WordPress harness in place.** `tests/wp-environment.test-support.ts` now wraps the repo-level `@test-utils/wp` helpers, exposes `createWordPressTestHarness()`, and is documented in the package README/AGENT so suites can opt in without cloning fixtures.【F:packages/core/tests/wp-environment.test-support.ts†L1-L111】【F:packages/core/README.md†L47-L58】【F:packages/core/AGENTS.md†L14-L21】
- [x] **Scoped action runtime overrides.** `tests/action-runtime.test-support.ts` provides `applyActionRuntimeOverrides()`/`withActionRuntimeOverrides()` with teardown safety and colocated tests to keep coverage healthy while eliminating ad-hoc global mutation.【F:packages/core/tests/action-runtime.test-support.ts†L1-L63】【F:packages/core/tests/**tests**/test-support.test.ts†L5-L62】
- [ ] **Cache helper unit specs.** Add lightweight suites for cache internals (`resource/cache`, invalidation queues) so integration suites focus on orchestration and no longer rely on conditional guards.【F:packages/core/src/**tests**/integration/cache-invalidation.test.ts†L29-L136】
- [ ] **Scenario matrices for resource/action flows.** Expand existing integration suites with `describe.each` coverage for retries, policy failures, and cross-tab scoping, leaning on the new harness utilities for setup reuse.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L26-L188】
- [x] **Documented helper conventions.** README and AGENT guidance now point contributors to the `.test-support.ts` helpers and repo-level globals to keep imports consistent with `tests/TEST_PATTERNS.md`.【F:packages/core/README.md†L47-L58】【F:packages/core/AGENTS.md†L14-L21】【F:tests/TEST_PATTERNS.md†L1-L122】
