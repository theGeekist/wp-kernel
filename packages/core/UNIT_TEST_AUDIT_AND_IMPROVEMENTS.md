# Unit Test Audit & Improvement Plan

## Key Observations

- Integration suites repeatedly stub `window.wp` objects, duplicating `apiFetch`, `hooks.doAction`, and data store mocks across files even though `tests/test-globals.d.ts`, `tests/test-utils/wp.test-support.ts`, and the legacy barrel `tests/test-utils/wp.ts` already expose canonical globals. The drift grows whenever WordPress APIs change.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L26-L52】【F:packages/core/src/**tests**/integration/resource-flow.test.ts†L23-L71】【F:tests/test-utils/wp.test-support.ts†L1-L115】【F:tests/test-utils/wp.ts†L1-L1】【F:tests/test-globals.d.ts†L1-L66】
- Several tests mutate globals (e.g., `__WP_KERNEL_ACTION_RUNTIME__`) to inject policies or background job state, creating hidden coupling between cases and requiring manual cleanup that `tests/TEST_PATTERNS.md` warns about but does not yet automate for core packages.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L165-L188】【F:tests/TEST_PATTERNS.md†L123-L166】
- Cache invalidation coverage exercises real `@wordpress/data` stores and includes conditional skips to accommodate missing resolver hooks, signalling an unreliable fixture surface and slow execution path.【F:packages/core/src/**tests**/integration/cache-invalidation.test.ts†L29-L136】
- Build verification suites focus on high-level flows but lack targeted assertions for edge cases like concurrent invalidations or transport retry semantics, making regressions hard to localise (no dedicated unit focus beyond integration harness).

## Actionable Improvements

1. Extract a shared `createWordPressTestHarness()` in `tests/wp-environment.test-support.ts` that wraps the repo-level `@test-utils/wp` helpers, centralises `window.wp` bootstrapping, and exposes `teardown()` for `afterEach` hooks. Publish the helper through `packages/core/AGENTS.md` so other suites reuse it instead of cloning fixtures.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L26-L52】【F:packages/core/src/**tests**/integration/resource-flow.test.ts†L23-L71】【F:tests/TEST_PATTERNS.md†L207-L226】
2. Replace ad-hoc global mutation with scoped helpers such as `withActionRuntimeOverrides({ policy })`, implemented via `jest.spyOn`/`jest.replaceProperty`, to ensure overrides are reset automatically after each test case. The helper should live in `tests/action-runtime.test-support.ts` and include self-tests so coverage thresholds are not penalised.【F:packages/core/src/**tests**/integration/action-flow.test.ts†L165-L188】
3. Introduce lightweight unit specs for cache helper modules (`resource/cache`, invalidation queues) using synthetic stores so integration tests can narrow their responsibility to orchestration, trimming reliance on conditional guards.【F:packages/core/src/**tests**/integration/cache-invalidation.test.ts†L29-L136】
4. Add scenario matrices with `describe.each` for resource/action flows to cover retries, policy failures, and cross-tab scoping independently. This reduces the need for monolithic tests and makes it easier to add new behaviours without duplicating boilerplate setups.
5. Document the `.test-support.ts` naming convention and existing globals in `README.md`, `AGENTS.md`, and per-suite docs so contributors consistently import helpers from `@test-utils/wp` (or the package barrels) rather than recreating stubs. Cross-link to `tests/TEST_PATTERNS.md` for authoritative guidance.【F:tests/TEST_PATTERNS.md†L1-L122】【F:tests/test-utils/wp.test-support.ts†L1-L115】
