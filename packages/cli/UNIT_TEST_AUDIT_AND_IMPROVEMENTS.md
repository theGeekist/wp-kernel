# Unit Test Audit & Improvement Plan

## Key Observations

- Current coverage is limited to config surfacing and the version export; there are no assertions around command parsing, project scaffolding, or error handling pathways.【F:packages/cli/src/**tests**/bundler-config.test.ts†L1-L31】【F:packages/cli/src/**tests**/version.test.ts†L1-L8】
- ESLint rule suites re-create `RuleTester` instances, parser configuration, and shared source headers for every rule grouping, leading to verbose fixtures that are difficult to extend consistently even though we already document reusable setup expectations in `tests/TEST_PATTERNS.md` and support reuse via the shared `tests/test-utils/wp.test-support.ts` exports.【F:packages/cli/**tests**/eslint-rules/kernel-config-rules.test.ts†L1-L125】【F:tests/TEST_PATTERNS.md†L78-L122】【F:tests/test-utils/wp.test-support.ts†L1-L115】
- Tests rely on inline template strings for generated config files, so real template drift or CLI output regressions are not automatically caught.

## Actionable Improvements

- [ ] **Workspace-level CLI integration tests.** Execute `bin/wpkernel` against isolated temp workspaces (leveraging `@wpkernel/e2e-utils`) to assert scaffold flows, help output, and failure messaging end-to-end.
- [x] **Rule tester helper extracted.** `tests/rule-tester.test-support.ts` centralises ESLint parser options plus fixture builders, ships self-tests, and is documented in the AGENT/README for discoverability.【F:packages/cli/tests/rule-tester.test-support.ts†L1-L105】【F:packages/cli/tests/**tests**/rule-tester.test.ts†L1-L40】【F:packages/cli/AGENTS.md†L12-L16】【F:packages/cli/README.md†L44-L48】
- [x] **Reporter mock helper shared.** `tests/reporter.test-support.ts` now supplies the canonical reporter mock used across adapter and command suites, replacing bespoke implementations and shipping dedicated unit coverage so future tweaks remain safe.【F:packages/cli/tests/reporter.test-support.ts†L1-L32】【F:packages/cli/tests/**tests**/reporter.test.ts†L1-L24】【F:packages/cli/src/adapters/**tests**/extensions.test.ts†L1-L24】【F:packages/cli/src/commands/**tests**/run-generate.test.ts†L1-L15】
- [x] **Stream harness shared.** `tests/memory-stream.test-support.ts` now centralises the writable stream used by CLI command suites, removing the per-file `MemoryStream` implementations and pairing the helper with focused unit tests.【F:packages/cli/tests/memory-stream.test-support.ts†L1-L25】【F:packages/cli/tests/**tests**/memory-stream.test.ts†L1-L21】【F:packages/cli/src/commands/**tests**/build-command.test.ts†L1-L104】【F:packages/cli/src/commands/**tests**/start-command.test.ts†L1-L120】
- [x] **Golden-file assertions for generators.** Generator suites snapshot `.generated` output against committed fixtures, ensuring template drift is surfaced through focused assertions.【F:packages/cli/src/commands/**tests**/**fixtures**/default.json†L1-L12】【F:packages/cli/src/commands/**tests**/generate-command.test.ts†L20-L68】
- [x] **Printer and adapter coverage.** UI printer suite now exercises screen, fixture, and menu emission through mocked filesystem boundaries while asserting serialisation failures bubble as kernel errors, rounding out adapter/printer behaviour coverage.【F:packages/cli/src/printers/ui/**tests**/printer.test.ts†L1-L200】
- [x] **Consistent helper naming & docs.** `.test-support.ts` naming is enforced for new utilities, with guidance published alongside links back to `tests/TEST_PATTERNS.md` to keep imports consistent across packages.【F:packages/cli/tests/rule-tester.test-support.ts†L1-L105】【F:tests/TEST_PATTERNS.md†L1-L122】
- [x] **Command harness & workspace utilities.** Shared helpers now attach CLI command contexts, async flush behaviour, and disposable workspaces so suites stop reimplementing boilerplate setup/teardown logic, cutting duplication across command/config tests while documenting behaviour through dedicated unit coverage.【F:packages/cli/tests/cli-command.test-support.ts†L1-L43】【F:packages/cli/tests/async.test-support.ts†L1-L26】【F:packages/cli/tests/workspace.test-support.ts†L1-L46】【F:packages/cli/tests/**tests**/cli-command.test.ts†L1-L32】【F:packages/cli/tests/**tests**/async.test.ts†L1-L38】【F:packages/cli/tests/**tests**/workspace.test.ts†L1-L38】【F:packages/cli/src/commands/**tests**/build-command.test.ts†L1-L107】【F:packages/cli/src/commands/**tests**/start-command.test.ts†L1-L220】【F:packages/cli/src/commands/**tests**/init-command.test.ts†L1-L200】【F:packages/cli/src/config/**tests**/load-kernel-config.test.ts†L1-L60】
