# wpk CLI MVP Plan

_See [Docs Index](./index.md) for navigation._

> **Versioning reminder:** The CLI now rides the unified **v0.6.x (pre-1.0)** track. Phase 2 patch slots (0.5.1-0.5.4) are closed; Phase 3 work uses the 0.6.1-0.6.4 band. Claim the next available slot before you start, update the status when you land, and consolidate into the parent phase release once every patch in that band ships.

## Coordination & guardrails

- **Non-negotiables:** Helpers that participate in the next pipeline must retain AST-first behaviour. Never introduce or wrap string-based PHP printers, and reserve the `create*` prefix for helpers produced by `createHelper` (alias third-party `create*` imports if needed).
- **Parallel runs:** Before picking up work, check the reserved version slot and set its status to `ðŸš§ in-progress`. When your PR merges, flip the slot to `âœ“ shipped` and note the PR link so downstream phases can verify all prerequisites.
- **Required checks (baseline):** Every task runs at least `pnpm --filter @wpkernel/cli lint`, `pnpm --filter @wpkernel/cli typecheck`, `pnpm --filter @wpkernel/cli typecheck:tests`, and `pnpm --filter @wpkernel/cli test`. Tasks that touch the PHP driver also run `pnpm --filter @wpkernel/php-driver test`. Parent phase releases add the full suite listed in [CLI Migration Phases](./cli-migration-phases.md).
- **Version bumps happen last:** Reserve your slot up front, implement and review without touching package versions, then-after approvals and a fresh rebase-apply the bump across all packages/CHANGELOGs in a final commit before merging. Update the ledger entry with the PR link as you flip it to `âœ“ shipped`.
- **Snapshot updates:** When tests rely on Jest snapshots, rerun them with `pnpm --filter @wpkernel/cli test -u` and include the updated files in your patch.

### Phase 0

| Slot  | Scope                                             | Status    | Notes                                                         | Detail reference                                                                                                                       |
| ----- | ------------------------------------------------- | --------- | ------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 0.4.1 | Task 1 - Harden PHP writer helper                 | âœ“ shipped | Coverage + logging guardrails landed via writer helper tests. | [Pipeline integration hardening](./pipeline-integration-tasks.md#item1--harden-next-php-writer-helper-complexity-lowmedium)            |
| 0.4.2 | Task 2 - Audit PHP builder helpers for AST purity | âœ“ shipped | Verify all helpers use canonical factories + add tests.       | [Pipeline integration hardening](./pipeline-integration-tasks.md#item2--audit-php-builder-helpers-for-ast-purity-complexity-medium)    |
| 0.4.3 | Task 3 - End-to-end generate coverage             | âœ“ shipped | Integration test snapshots cover PHP + AST artefacts.         | [Pipeline integration hardening](./pipeline-integration-tasks.md#item3--end-to-end-generate-pipeline-coverage-complexity-mediumhigh)   |
| 0.4.4 | Task 4 - Driver configuration & documentation     | âœ“ shipped | Update docs + exports alongside code.                         | [Pipeline integration hardening](./pipeline-integration-tasks.md#item4--surface-driver-configuration--documentation-complexity-medium) |

### Phase 1 - Resource Parity & Apply Layering (âœ“ Complete)

| Slot  | Scope                                           | Status    | Notes                                                                                                   | Detail reference                                                                                           |
| ----- | ----------------------------------------------- | --------- | ------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 0.4.5 | Task 5 - (wp-option parity) - AST builders land | âœ“ shipped | AST builders + helpers for wp-option controllers now live in the next pipeline.                         | [PHP AST migration - Phase 1 deliverables](./php-ast-migration-tasks.md#phase-1--wp-option-storage-parity) |
| 0.4.6 | Task 6 - wp-option parity tests                 | âœ“ shipped | Snapshot coverage + writer assertions confirm queued `PhpProgram` payloads emit matching PHP/AST pairs. | [PHP AST migration - Phase 1 deliverables](./php-ast-migration-tasks.md#phase-1--wp-option-storage-parity) |
| 0.4.7 | Task 7 - wp-option fixtures/docs                | âœ“ shipped | Integration fixtures now queue wp-option controllers and docs capture the updated flows.                | [PHP AST migration - Phase 1 deliverables](./php-ast-migration-tasks.md#phase-1--wp-option-storage-parity) |
| 0.4.8 | Task 8 - Buffer hotfix for Phase 1 work         | âœ“ shipped | No regressions surfaced after review; buffer slot closed without requiring a patch.                     | [PHP AST migration - Version cadence](./php-ast-migration-tasks.md#version-cadence)                        |
| 0.4.9 | Task 9 - Release engineering prep               | âœ“ shipped | Changelog rollup + monorepo version bump prepared for the 0.5.0 handoff.                                | [Release process](../../RELEASING.md#1%EF%B8%8F%E2%83%A3-versioning-rules)                                 |
| 0.5.0 | Task 10 - **Phase 1 minor**                     | âœ“ shipped | All 0.4.x slots closed; 0.5.0 shipped via the unified release checklist.                                | [Release process](../../RELEASING.md#3%EF%B8%8F%E2%83%A3-release-process)                                  |

### Phase 2 - Transient Storage Parity (âœ“ Complete)

| Slot  | Scope                                      | Status    | Notes                                                                                                                | Detail reference                                                                                       |
| ----- | ------------------------------------------ | --------- | -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 0.5.1 | Task 11 - Transient AST builders land      | âœ“ shipped | AST helpers for transient controllers now live in the next pipeline with key sanitisation + TTL normalisation.       | [Phase 2 - transient builders](./php-ast-migration-tasks.md#task-11--transient-ast-builders)           |
| 0.5.2 | Task 12 - Transient parity tests           | âœ“ shipped | Builder and controller suites cover transient cache metadata, TTL helpers, and WP_Error fallbacks.                   | [Phase 2 - transient tests](./php-ast-migration-tasks.md#task-12--transient-parity-tests)              |
| 0.5.3 | Task 13 - Transient fixtures & docs        | âœ“ shipped | CLI goldens + docs refreshed so transient helpers surface in fixtures and contributor guides.                        | [Phase 2 - transient fixtures/docs](./php-ast-migration-tasks.md#task-13--transient-fixtures-and-docs) |
| 0.5.4 | Task 14 - Buffer slot for transient parity | âœ“ shipped | DELETE handlers now clear transient storage and emit cache invalidation events so per-entity caches stay consistent. | [Phase 2 - buffer cadence](./php-ast-migration-tasks.md#task-14--phase-2-buffer-slot)                  |
| 0.6.0 | Task 15 - **Phase 2 minor**                | âœ“ shipped | 0.6.0 cut with full release checks after closing the transient buffer slot; Phase 3 patch band now open.             | [Release process](../../RELEASING.md#3%EF%B8%8F%E2%83%A3-release-process)                              |

### Phase 3 - Block Builder Parity (â¬œ Planned)

| Slot  | Scope                                    | Status     | Notes                                                                                                                                                                                                                                                                                                                                                                | Detail reference                                                 |
| ----- | ---------------------------------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| 0.6.1 | Task 16 - Block builder implementation   | â¬œ planned | Port the legacy block printers (`packages/cli/src/printers/blocks/ssr.ts`, `packages/cli/src/printers/blocks/js-only.ts`) into the AST-first pipeline with shared `ts-morph` primitives feeding both `createBlocksBuilder` and `createTsBuilder` outputs. Complexity: medium-the task rewrites the manifest, registrar, and per-block `render.php` generation paths. | [Phase 3 - implementation](./php-ast-migration-tasks.md#task-16) |
| 0.6.2 | Task 17 - Block parity tests             | â¬œ planned | Extend unit/integration suites to assert `ts-morph` output, SSR AST programs, manifest metadata, and the regenerated `render.php` stubs against the behaviour captured in `packages/cli/src/printers/blocks/__tests__/**`. Complexity: medium-exercise SSR + JS-only permutations and cache/reporting paths.                                                         | [Phase 3 - tests](./php-ast-migration-tasks.md#task-17)          |
| 0.6.3 | Task 18 - Block fixtures & documentation | â¬œ planned | Refresh fixtures/docs to describe the new pipeline, reference the retired printers, and guide authors through the manifest/registrar `render.php` outputs now produced by the AST + `ts-morph` builders. Complexity: medium-touches docs, goldens, and changelog notes in one run.                                                                                   | [Phase 3 - fixtures/docs](./php-ast-migration-tasks.md#task-18)  |
| 0.6.4 | Task 19 - Phase 3 buffer slot            | â¬œ planned | Hold capacity for polish or regressions (for example, AST emit ordering or `ts-morph` import churn) ahead of the 0.7.0 release. Use this medium-complexity slot if manifest, registrar, or `render.php` diffs surface late.                                                                                                                                          | [Phase 3 - buffer](./php-ast-migration-tasks.md#task-19)         |

### Phase 4 - Command Migration & String Printer Retirement (â¬œ Planned)

| Slot  | Scope                                               | Status     | Notes                                                                                                                              | Detail reference                                                                                                    |
| ----- | --------------------------------------------------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| 0.7.1 | Task 20 - Apply command factory & manifest plumbing | â¬œ planned | Introduce `buildApplyCommand`, expose dependency-injection seams for the patcher/manifest helpers, and document the orchestration. | [Command migration - apply](./command-migration-plan.md#31-apply)                                                   |
| 0.7.2 | Task 21 - Init/create parity                        | â¬œ planned | Rebuild init on the next helpers, add git warnings, and ship the `create` wrapper that installs npm/composer deps.                 | [Command migration - init/create](./command-migration-plan.md#33-init)                                              |
| 0.7.3 | Task 22 - Native generate command                   | â¬œ planned | Compose `createPipeline`, diagnostics, and workspace transactions to remove the legacy generate shim.                              | [Command migration - generate](./command-migration-plan.md#32-generate)                                             |
| 0.7.4 | Task 23 - Start & doctor orchestration              | â¬œ planned | Implement the native watcher (chokidar tiers, optional auto-apply) and doctor health checks on top of the next pipeline.           | [Command migration - start](./command-migration-plan.md#35-start) / [doctor](./command-migration-plan.md#36-doctor) |
| 0.8.0 | Task 24 - **Phase 4 minor**                         | â¬œ planned | Retire string printers and the legacy command layer once all command factories land; run full release checks before cutting 0.8.0. | [Command migration summary](./command-migration-plan.md#4-dependencies--sequencing)                                 |

### Phase 5 - Apply Layering & Flags (â¬œ Planned)

| Slot  | Scope                                         | Status     | Notes                                                                                                                                 | Detail reference                                                                                       |
| ----- | --------------------------------------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 0.8.1 | Task 25 - Shim generation & composer fallback | â¬œ planned | Emit extension shims, compute `require_once` fallbacks when composer autoload is missing, and persist builder actions into manifests. | [Apply workflow - shims](./apply-workflow-phases.md#3-implementation-plan)                             |
| 0.8.2 | Task 26 - Flags, git enforcement, logging     | â¬œ planned | Port `--yes/--backup/--force`, require `.git`, append `.wpk-apply.log`, and align reporter output with the legacy command.            | [Apply workflow - safety rails](./apply-workflow-phases.md#3-implementation-plan)                      |
| 0.8.3 | Task 27 - Integration coverage                | â¬œ planned | Expand builder/command tests to cover shim regeneration, composer vs `require_once` flows, and log outputs.                           | [Apply workflow - tests](./apply-workflow-phases.md#3-implementation-plan)                             |
| 0.8.4 | Task 28 - Buffer slot                         | â¬œ planned | Hold capacity for late polish or regression fixes before cutting 0.9.0 (e.g., shim conflict messaging or git edge cases).             | [Apply workflow guard](./apply-workflow-phases.md#1-current-state-next)                                |
| 0.9.0 | Task 29 - **Phase 5 minor**                   | â¬œ planned | Ship the layered apply workflow with full release checks (`wpk generate && wpk apply --yes --dry-run`) and document the migration.    | [Apply workflow release checklist](./apply-workflow-phases.md#phase-05---apply-workflow-next-pipeline) |

## Definition of "MVP"

We consider the CLI ready for the MVP launch when the following are true:

1. Builders emit AST-driven artefacts for every supported storage mode (wp-post, wp-taxonomy, wp-option, transient) and blocks.
2. Block generation runs through the next pipeline (manifests/registrars/render templates) with no reliance on string-based printers.
3. `wpk apply` updates user shims that extend generated classes, honours all safety flags, and logs actions.
4. Pipeline helpers expose configuration hooks (e.g., PHP driver options) without deep imports, and integration tests cover end-to-end `generate` + `apply` flows.
5. All documentation (`cli-migration-phases.md`, `php-ast-migration-tasks.md`, `apply-workflow-phases.md`, `adapter-dx.md`, `pipeline-integration-tasks.md`) reflects the current architecture.

## Task evaluation workflow

When opening any task below, instruct the agent as follows:

```
Evaluate {Task Name} #{Task ID}. Read all linked documentation and consider the scope of work. Look at the current state and tell me if this can be completed in a single run. Otherwise, propose a scoped plan to complete it in smaller steps.
```

Before coding, the agent must review `AGENTS.md`, the referenced documentation, and the code paths noted in the task. Every task assumes the next-generation pipeline (`packages/cli/src/next/**`) is the only surface to touch-do not revive string-based printers or helper naming patterns reserved for the pipeline (e.g., no new `create*` exports unless they are pipeline helpers).

## Phases

| ID  | Phase                             | Summary & Scope                                                                                                                                                                                               | Reserved version                            | Required checks                                                            | Detail reference                                                                                           |
| --- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------- | -------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 0   | Harden PHP writer helper          | Tasks 1-4 delivered core pipeline stability, AST builder integrity, and PHP driver configurability. This phase established baseline coverage and documentation, forming the foundation for subsequent phases. | 0.4.4 (patch)                               | Baseline + `pnpm --filter @wpkernel/cli test -- --testPathPatterns writer` | [Pipeline integration hardening](./pipeline-integration-tasks.md)                                          |
| 1   | wp-option AST parity              | Build wp-option controllers/helpers in `packages/cli/src/next/builders/php/resource/**`, add tests, update fixtures, and remove dependency on `printers/php/wp-option.ts`.                                    | 0.4.5-0.4.7 (patch band) â†’ 0.5.0 minor      | Baseline + `pnpm --filter @wpkernel/cli test --testPathPattern=wp-option`  | [PHP AST migration - Phase 1](./php-ast-migration-tasks.md#phase-1--wp-option-storage-parity)              |
| 2   | Transient AST parity              | Port transient controllers/helpers to the AST pipeline with full test coverage, matching behaviour in `printers/php/transient.ts`.                                                                            | 0.5.1-0.5.3 (patch band) â†’ 0.6.0 minor      | Baseline + `pnpm --filter @wpkernel/cli test --testPathPattern=transient`  | [PHP AST migration - Phase 2](./php-ast-migration-tasks.md#phase-2--transient-storage-parity-)             |
| 3   | Blocks builder                    | Implement a next-gen blocks builder (SSR + JS-only) that stages manifests/registrars/render templates via the workspace transaction and migrate tests. Unlocks once Phase 2 (0.6.0) is complete.              | 0.6.1 (patch - available after 0.6.0 ships) | Baseline + `pnpm --filter @wpkernel/cli test -u` (update block snapshots)  | [Blocks builder scope](./pipeline-integration-tasks.md#future-focus--add-blocks-builder-complexity-medium) |
| 4   | Apply layering & flags            | Emit user extension shims, port `--yes/--backup/--force` handling, `.wpk-apply.log`, and add integration tests for the new workflow.                                                                          | 0.8.1-0.8.3 (patch band) â†’ 0.9.0 minor      | Baseline + end-to-end `wpk apply` smoke run                                | [Apply workflow phase](./apply-workflow-phases.md)                                                         |
| 5   | Update documentation & lint links | After code tasks complete, ensure all documentation and lint rule links reflect the final state.                                                                                                              | Use next available patch in active cycle    | Baseline + `pnpm lint --fix`                                               | [Docs index refresh](./index.md)                                                                           |

Each task should be executed independently; if a task proves too large for a single agent run, the agent must scope it into smaller follow-up tasks using the evaluation workflow above.
