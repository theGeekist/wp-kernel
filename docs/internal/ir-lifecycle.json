{
	"overview": {
		"entryPoints": {
			"config": {
				"module": "packages/cli/src/config/load-wpk-config.ts",
				"description": "Discovers and validates wpk.config definitions before any pipeline work runs.",
				"async": true
			},
			"cliPipeline": {
				"module": "packages/cli/src/runtime/createPipeline.ts",
				"description": "Wraps @wpkernel/pipeline to assemble IR fragments, artifact builders, adapter hooks, and apply tooling.",
				"async": true
			},
			"coreRuntime": {
				"modules": [
					"packages/core/src/resource/define.ts",
					"packages/core/src/pipeline/resources/createResourcePipeline.ts",
					"packages/core/src/pipeline/actions/createActionPipeline.ts",
					"packages/core/src/data/configure-kernel.ts"
				],
				"description": "Consumes generated IR artifacts, registers runtime pipelines, and bridges the same config surface for in-app execution.",
				"async": false
			}
		},
		"irFlow": [
			"load-wpk-config resolves namespace, schema registry, resources, and adapter hooks (async)",
			"CLI pipeline builds MutableIr via fragments, finalises IRv1, then hands to builders",
			"Builders emit PHP controllers, plugin loader, TypeScript admin/UI runtime, JS bundler config, SSR-aware blocks, and generation plans",
			"Adapter extensions receive sandboxed IR snapshots to mutate artifacts before commit",
			"Apply phase replays fragments synchronously for patch planning and runs the patcher",
			"Core runtime pipelines synchronously read config-derived types at boot (defineResource, actions, configureWPKernel) and reuse shared helper patterns"
		]
	},
	"config": {
		"loader": {
			"module": "packages/cli/src/config/load-wpk-config.ts",
			"supports": ["wpk.config.ts", "wpk.config.js", "package.json#wpk"],
			"steps": [
				"Resolve config via cosmiconfig with TSX loader fallback",
				"Await ESM/CJS exports, unwrap default promises, and validate with validateWPKernelConfig",
				"Verify Composer autoload namespace alignment via validateComposerAutoload",
				"Return LoadedWPKernelConfig containing namespace, origin, composer check state, and absolute sourcePath"
			],
			"outputs": {
				"config": "WPKernelConfigV1",
				"namespace": "Sanitised later by the meta fragment",
				"configOrigin": "@wpkernel/core/contracts#WPK_CONFIG_SOURCES literal",
				"sourcePath": "Absolute path to discovered config",
				"composerCheck": "'ok' | 'mismatch'"
			},
			"async": true
		},
		"shape": {
			"version": 1,
			"namespace": "Raw namespace; sanitised and PHP namespace derived by CLI meta fragment",
			"schemas": {
				"path": "Absolute or relative JSON schema reference; resolved relative to config",
				"generated.types": "Relative ts-morph output path for generated schema types",
				"description": "Optional documentation string"
			},
			"resources": {
				"name": "Human readable label surfaced throughout IR",
				"routes": "Record of REST route descriptors (method, path, capability hints, transport overrides)",
				"schema": "Explicit schema key or 'auto' for storage-derived schema synthesis",
				"storage": "Descriptor for persistence (postType/meta/taxonomy/etc) powering PHP scaffolding and schema synthesis",
				"identity": "ResourceIdentityConfig selecting primary key fields and capability binding hints",
				"queryParams": "ResourceQueryParams definition powering client + dataview typing",
				"cacheKeys": "CacheKeys overrides merged with defaults by resource builder and core pipeline",
				"ui": "ResourceUIConfig driving admin screen generation, DataViews fixtures, menu metadata, and plugin loader wiring",
				"capabilities": "Inline ResourceCapabilityMap definitions merged into capability-map fragment",
				"capabilityMap": "Resolved globally by capability-map fragment via collected hints"
			},
			"adapters": {
				"php": "Optional AdapterContext => PhpAdapterConfig factory overriding namespace/autoload and injecting customise() callbacks for PHP builder",
				"extensions": "AdapterExtensionFactory list executed after builders with sandboxed write/rollback"
			}
		}
	},
	"pipelineEngine": {
		"createPipeline": {
			"module": "packages/pipeline/src/createPipeline.ts",
			"responsibilities": [
				"Registers helpers by kind with dependency graph validation",
				"Executes helpers sequentially with async-aware maybeThen/maybeTry",
				"Collects diagnostics and helper execution snapshots",
				"Supports commit/rollback protocol per helper",
				"Provides extension hook orchestration (pre-run, post-fragment, post-builder, pre-commit)"
			],
			"async": true
		},
		"createExtension": {
			"module": "packages/pipeline/src/createExtension.ts",
			"patterns": {
				"register": "Dynamic hook registration returning hook per pipeline instance; awaited when async",
				"setup+hook": "Optional setup stage (can register helpers) plus statically declared hook",
				"commitRollback": "Hooks can return commit/rollback promises to integrate with pipeline error handling"
			},
			"consumedBy": [
				"packages/cli/src/runtime/createPipeline.ts (via PipelineExtensionHookOptions mapping)",
				"packages/core/src/pipeline/resources/extensions/createFinalizeResourceDefinitionExtension.ts",
				"packages/cli/src/adapters/extensions.ts (adapter extension factories wrap createPipelineExtension via CLI runtime)"
			]
		}
	},
	"ir": {
		"draft": {
			"type": "MutableIr",
			"fields": {
				"meta": "null until meta fragment assigns version/namespace/source",
				"config": "Validated WPKernelConfigV1",
				"schemas": "IRSchema[] from schema fragment (manual + auto)",
				"resources": "IRResource[] built with routes, storage, hashes, UI metadata",
				"capabilities": "IRCapabilityHint[] collected from resource routes and inline capability declarations",
				"capabilityMap": "Resolved map or null until capability-map fragment",
				"blocks": "IRBlock[] from block discovery (key, directory, hasRender)",
				"php": "IRPhpProject seeded by meta fragment",
				"diagnostics": "IRDiagnostic[] aggregated from fragments",
				"extensions": "Scratchpad for cross-fragment state (sanitised namespace, schema accumulator, warnings)"
			}
		},
		"final": {
			"type": "IRv1",
			"finalisation": [
				"finalizeIrDraft enforces execution of core fragments before return",
				"validation fragment asserts meta + capabilityMap + schema associations exist"
			],
			"fields": {
				"meta": "{ version:1, namespace, sourcePath (workspace-relative), origin, sanitizedNamespace }",
				"config": "Original WPKernelConfigV1",
				"schemas": "IRSchema entries with provenance ('manual' | 'auto') and generatedFrom metadata",
				"resources": "IRResource entries with normalised routes, derived cache keys, storage + query metadata, UI config snapshot, deterministic hash, warnings",
				"capabilities": "IRCapabilityHint[] linking capability keys to resources/routes",
				"capabilityMap": "IRCapabilityMap containing definitions, fallback, missing/unused lists, warnings, optional sourcePath",
				"blocks": "IRBlock[] describing discovered or generated blocks with SSR detection",
				"php": "IRPhpProject { namespace, autoload, outputDir }",
				"diagnostics": "Optional IRDiagnostic[] from fragments"
			}
		},
		"hashing": {
			"resources": {
				"module": "packages/cli/src/ir/shared/resource-builder.ts",
				"function": "hashResource",
				"inputs": "ResourceConfig, schemaKey/provenance, normalised routes, derived cacheKeys, identity/storage/queryParams, UI config",
				"purpose": "Detect config drift for incremental rebuilds and apply plan diffing"
			}
		}
	},
	"cli": {
		"phases": {
			"generate": {
				"runs": [
					"All IR fragments",
					"Bundler helper",
					"PHP builders (controllers, plugin loader, persistence registries)",
					"JS/TS builders (blocks, UI)",
					"Apply plan builder",
					"Adapter extensions"
				],
				"notes": [
					"Builders guard on input.phase === 'generate'",
					"Adapter extensions execute after builders and receive sandboxed IR clones"
				]
			},
			"apply": {
				"runs": [
					"IR fragments (to rebuild IRv1 from config)",
					"Patcher builder"
				],
				"notes": [
					"createApplyPlanBuilder runs during generate to produce plan consumed here",
					"PHP/TS/JS builders exit early in apply phase"
				]
			}
		},
		"fragments": [
			{
				"key": "ir.meta.core",
				"module": "packages/cli/src/ir/fragments/meta.ts",
				"dependsOn": [],
				"produces": ["meta", "php namespace/autoload/outputDir"],
				"consumes": ["config.namespace", "config.origin", "sourcePath"],
				"async": true,
				"notes": [
					"Sanitises namespace",
					"Stores sanitizedNamespace extension for downstream fragments"
				]
			},
			{
				"key": "ir.schemas.core",
				"module": "packages/cli/src/ir/fragments/schemas.ts",
				"dependsOn": [],
				"produces": ["schemas", "SchemaAccumulator extension"],
				"consumes": ["config.schemas", "config.sourcePath"],
				"async": true,
				"notes": [
					"Resolves manual schemas",
					"Synthesises auto schemas via storage metadata"
				]
			},
			{
				"key": "ir.resources.core",
				"module": "packages/cli/src/ir/fragments/resources.ts",
				"dependsOn": ["ir.meta.core", "ir.schemas.core"],
				"produces": ["resources"],
				"consumes": [
					"SchemaAccumulator",
					"sanitizedNamespace",
					"config.resources"
				],
				"async": true,
				"notes": [
					"Normalises routes, derives capabilities, caches, identities",
					"Preserves ResourceUIConfig for builders and plugin loader",
					"Computes resource hash and warning list"
				]
			},
			{
				"key": "ir.capabilities.core",
				"module": "packages/cli/src/ir/fragments/capabilities.ts",
				"dependsOn": ["ir.resources.core"],
				"produces": ["capabilities"],
				"consumes": ["resource.routes", "resource.capabilities"],
				"async": true,
				"notes": [
					"Collects IRCapabilityHint entries for capability map resolution"
				]
			},
			{
				"key": "ir.capability-map.core",
				"module": "packages/cli/src/ir/fragments/capability-map.ts",
				"dependsOn": ["ir.resources.core", "ir.capabilities.core"],
				"produces": ["capabilityMap"],
				"consumes": ["IRResource[]", "IRCapabilityHint[]"],
				"async": true,
				"notes": [
					"Merges inline capability definitions",
					"Flags missing/unused keys",
					"Defaults fallback to manage_options"
				]
			},
			{
				"key": "ir.blocks.core",
				"module": "packages/cli/src/ir/fragments/blocks.ts",
				"dependsOn": ["ir.meta.core"],
				"produces": ["blocks"],
				"consumes": ["workspace root from sourcePath"],
				"async": true,
				"notes": [
					"Recursively discovers block.json manifests",
					"Flags SSR via render.php or manifest render entry"
				]
			},
			{
				"key": "ir.ordering.core",
				"module": "packages/cli/src/ir/fragments/ordering.ts",
				"dependsOn": [
					"ir.schemas.core",
					"ir.resources.core",
					"ir.capabilities.core",
					"ir.blocks.core"
				],
				"produces": ["sorted schemas/resources/capabilities/blocks"],
				"consumes": ["draft collections"],
				"async": true,
				"notes": ["Guarantees deterministic ordering for generation"]
			},
			{
				"key": "ir.diagnostics.core",
				"module": "packages/cli/src/ir/fragments/diagnostics.ts",
				"dependsOn": ["ir.resources.core"],
				"produces": ["diagnostics"],
				"consumes": ["resource warnings"],
				"async": true,
				"notes": ["Collates IR warnings into IRDiagnostic entries"]
			},
			{
				"key": "ir.validation.core",
				"module": "packages/cli/src/ir/fragments/validation.ts",
				"dependsOn": [
					"ir.meta.core",
					"ir.resources.core",
					"ir.capability-map.core"
				],
				"produces": [],
				"consumes": ["meta", "capabilityMap", "resource.schemaKey"],
				"async": true,
				"notes": [
					"Ensures core fragments executed and IR invariants hold"
				]
			}
		],
		"builders": {
			"php": {
				"entry": "packages/cli/src/builders/php/index.ts",
				"helpers": [
					{
						"key": "builder.generate.php.plugin-loader",
						"module": "packages/cli/src/builders/php/pluginLoader.ts",
						"phase": "generate",
						"async": true,
						"produces": "plugin.php with UI bootstrap, REST controller includes, localisation wiring",
						"consumes": [
							"IRResource[]",
							"IR.meta",
							"ResourceUIConfig admin dataviews"
						],
						"notes": [
							"Skips overwriting user-owned loader lacking AUTO_GUARD",
							"Derives menu metadata + preferences from resource.ui",
							"Requires sanitised namespace for script handles"
						]
					},
					{
						"key": "builder.generate.php.resource-controller",
						"module": "packages/cli/src/builders/php/resourceController.ts",
						"phase": "generate",
						"async": true,
						"produces": "REST controller classes per resource with storage + schema awareness",
						"consumes": [
							"IRResource routes",
							"capabilityMap",
							"storage",
							"schema"
						],
						"notes": [
							"Emits PHP classes under IR.php.namespace\\Rest",
							"Registers capabilities map into controllers"
						]
					},
					{
						"key": "builder.generate.php.persistence",
						"module": "packages/cli/src/builders/php/persistenceRegistry.ts",
						"phase": "generate",
						"async": true,
						"produces": "Persistence registry + storage helpers wired from resource.storage",
						"consumes": ["IRResource.storage", "schemas"],
						"notes": [
							"Generates wp data store registration for post types/meta"
						]
					},
					{
						"key": "builder.generate.php.capabilities",
						"module": "packages/cli/src/builders/php/capability.ts",
						"phase": "generate",
						"async": true,
						"produces": "Capability map PHP definitions + fallback",
						"consumes": ["IRCapabilityMap"],
						"notes": [
							"Mirrors CLI capability map warnings into PHP docblocks"
						]
					}
				],
				"shared": [
					"packages/cli/src/builders/php/writer.ts (queues AST programs)",
					"packages/cli/src/builders/php/channel.ts (reports builder channel diagnostics)"
				]
			},
			"ts": {
				"module": "packages/cli/src/builders/ts.ts",
				"phase": "generate",
				"async": true,
				"produces": [
					"Admin screen React components under .generated/ui/app/<Resource>/admin",
					"DataView fixtures and registries under .generated/ui/fixtures",
					"Interactivity bindings referencing resource clients"
				],
				"consumes": [
					"ResourceUIConfig.admin.dataviews",
					"IR.meta",
					"IRResource"
				],
				"notes": [
					"Runs lifecycle hooks (before/after create, after emit) for adapters",
					"Validates imports via validateGeneratedImports",
					"Uses resource.hash + namespace for emitter pathing"
				]
			},
			"blocks": {
				"module": "packages/cli/src/builders/blocks/derived.ts",
				"phase": "generate",
				"async": false,
				"produces": "JS-only block manifests + IRBlock entries for eligible resources",
				"consumes": ["IR.resources", "IR.blocks existing map"],
				"notes": [
					"Determines SSR vs JS-only by storage presence + local routes",
					"Skips generation when workspace already declares block key",
					"Derives block attributes from resolved schema"
				]
			},
			"bundler": {
				"module": "packages/cli/src/builders/bundler.ts",
				"phase": "generate",
				"async": true,
				"produces": "Rollup driver config + asset manifest under .wpk/bundler",
				"consumes": [
					"package.json dependencies",
					"sanitised namespace",
					"ResourceUIConfig"
				],
				"notes": [
					"Generates WordPress handles + globals for externals",
					"Embeds UI script handle when UI resources exist"
				]
			},
			"applyPlan": {
				"module": "packages/cli/src/builders/plan.ts",
				"phase": "generate",
				"async": true,
				"produces": [
					".wpk/apply/plan.json",
					"base/incoming shims",
					"generation manifest"
				],
				"consumes": ["IRv1", "previous GenerationManifest"],
				"notes": [
					"Pretty-prints PHP via php-driver",
					"Generates shims referencing plugin loader + controllers",
					"Diffs against recorded generationState to plan deletions"
				]
			},
			"patcher": {
				"module": "packages/cli/src/builders/patcher.ts",
				"phase": "apply",
				"async": true,
				"produces": "Applies plan.json using system patch/execFile, records manifest",
				"consumes": [".wpk/apply/plan.json", "workspace fs"],
				"notes": [
					"Writes temp files in workspace tmpDir",
					"Captures conflicts/skips, writes manifest with summary"
				]
			}
		},
		"adapterExtensions": {
			"module": "packages/cli/src/adapters/extensions.ts",
			"async": true,
			"workflow": [
				"Clone IR per extension and execute inside sandbox directory",
				"queueFile writes into temp dir with formatting helpers",
				"updateIr allows extensions to mutate cloned IR snapshot",
				"commit flushes queued files into workspace after builders",
				"rollback deletes sandbox without persisting changes"
			],
			"inputs": ["AdapterExtensionFactory[]", "AdapterContext", "IRv1"],
			"outputs": ["Mutated IRv1", "commit/rollback controls"],
			"notes": [
				"Extension reporter scoped to sanitised extension name",
				"Composer autoload overrides propagate through AdapterContext"
			]
		}
	},
	"core": {
		"resourcePipeline": {
			"entryPoint": "packages/core/src/resource/define.ts",
			"pipeline": "packages/core/src/pipeline/resources/createResourcePipeline.ts",
			"async": false,
			"fragments": [
				{
					"module": "packages/core/src/pipeline/resources/helpers/createResourceValidationFragment.ts",
					"responsibility": "Validates ResourceConfig synchronously (routes, schema presence, capability bindings)",
					"produces": "Normalized config draft"
				},
				{
					"module": "packages/core/src/pipeline/resources/helpers/createResourceClientFragment.ts",
					"responsibility": "Builds typed client surface (fetchList/fetch/create/update/remove) using config routes",
					"produces": "ResourcePipelineDraft.client"
				},
				{
					"module": "packages/core/src/pipeline/resources/helpers/createResourceCacheKeysFragment.ts",
					"responsibility": "Merges default cache keys with config overrides",
					"produces": "cacheKeys"
				}
			],
			"builders": [
				{
					"module": "packages/core/src/pipeline/resources/helpers/createResourceObjectBuilder.ts",
					"responsibility": "Assemble final ResourceObject (clients, store keys, events)"
				}
			],
			"extensions": [
				{
					"module": "packages/core/src/pipeline/resources/extensions/createFinalizeResourceDefinitionExtension.ts",
					"responsibility": "Records resource defined events on commit and removes them on rollback via event bus"
				}
			],
			"notes": [
				"defineResource asserts pipeline.run result is synchronous (throws if Promise)",
				"Normalized config injects namespace defaults so runtime reuses CLI namespace rules"
			]
		},
		"actionPipeline": {
			"entryPoint": "packages/core/src/actions/define.ts",
			"pipeline": "packages/core/src/pipeline/actions/createActionPipeline.ts",
			"async": false,
			"fragments": [
				{
					"module": "packages/core/src/pipeline/actions/helpers/createActionOptionsResolver.ts",
					"responsibility": "Validate/normalise action args + options"
				},
				{
					"module": "packages/core/src/pipeline/actions/helpers/createActionContextAssembler.ts",
					"responsibility": "Build execution context (namespace, reporter, registry bridge, request id)"
				},
				{
					"module": "packages/core/src/pipeline/actions/helpers/createActionLifecycleFragment.ts",
					"responsibility": "Runs before/after lifecycle hooks declared on action config"
				}
			],
			"builders": [
				{
					"module": "packages/core/src/pipeline/actions/helpers/createActionExecutionBuilder.ts",
					"responsibility": "Invoke handler, capture result/errors, emit diagnostics"
				},
				{
					"module": "packages/core/src/pipeline/actions/helpers/createActionRegistryRecorder.ts",
					"responsibility": "Emit action:defined events via registry bridge"
				}
			],
			"notes": [
				"Pipeline context resolves reporter via resolveActionReporter",
				"Execution inherits same commit/rollback semantics from pipeline engine"
			]
		},
		"configureWPKernel": {
			"module": "packages/core/src/data/configure-kernel.ts",
			"async": false,
			"responsibilities": [
				"Normalises namespace, reporter, registry, and UI options",
				"Attaches action middleware + events middleware to wp.data registry",
				"Provides defineResource wrapper that respects namespace + reporter defaults",
				"Exposes UI attach hook consuming generated UI bundles (.generated outputs)"
			],
			"ui": {
				"normalisation": "normalizeUIConfig (preferencesKey defaults, attach hook)",
				"runtime": "attachUIBindings uses generated scripts/handles provided by CLI bundler + TS builders"
			}
		},
		"shared": {
			"pipelineHelpers": "packages/core/src/pipeline/helpers/context.ts exports CorePipelineContext bridging reporters + registry events",
			"events": "Resource/action finalize extensions publish to getWPKernelEventBus"
		}
	}
}
